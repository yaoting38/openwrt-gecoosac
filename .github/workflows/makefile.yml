
# .github/workflows/build.yml

name: Build OpenWrt Package (using SDK)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

# ======================================================================================
# ==                        ğŸ‘‡ User configuration area ğŸ‘‡                            ==
# ======================================================================================
env:
  # 1. Set the name of the package you want to compile (it must be the same as your package directory name).
  # For example: Luci-App-Adguardhome, V2ray-Core, KMOD-Wireguard, etc.
  # 1. è®¾ç½®ä½ è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…åç§° (å¿…é¡»ä¸ä½ çš„è½¯ä»¶åŒ…ç›®å½•åç›¸åŒ)
  #    ä¾‹å¦‚: luci-app-adguardhome, v2ray-core, kmod-wireguard ç­‰
  PACKAGE_NAME: GecoosAC

  # 2. Set the version of OpenWrt to compile (it must be the official release label, such as' v23.05.3').
  # Note: this method does not support' master' or' openwrt-23.05' and other branch names.
  # 2. è®¾ç½®è¦ç¼–è¯‘çš„ OpenWrt ç‰ˆæœ¬ (å¿…é¡»æ˜¯å®˜æ–¹çš„æ­£å¼å‘å¸ƒç‰ˆæ ‡ç­¾, ä¾‹å¦‚ 'v23.05.3')
  #    æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸æ”¯æŒ 'master' æˆ– 'openwrt-23.05' ç­‰åˆ†æ”¯å
  OPENWRT_VERSION: 'v24.10'

  # 3. Specify the SDK save directory, generally without modification.
  # 3. æŒ‡å®šSDKä¿å­˜ç›®å½•ï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹
  SDK_DIR: /home/runner/work/openwrt-sdk
# ======================================================================================
# ==                        ğŸ‘† User configuration area ğŸ‘†                            ==
# ======================================================================================

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.target.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          # The compiled path is found here in https://downloads.openwrt.org/releases/24.10.3/targets, and the name is anything.
          # ç¼–è¯‘çš„pathåœ¨https://downloads.openwrt.org/releases/24.10.3/targets è¿™é‡ŒæŸ¥æ‰¾ï¼Œnameéšæ„
          - name: x86_64
            path: x86/64
          - name: mediatek_filogic
            path: mediatek/filogic
          - name: mips_mt7621
            path: ramips/mt7621

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout package repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential rsync unzip zstd

      # æ­¥éª¤ 3: ç¼“å­˜ OpenWrt SDK
      # ç¼“å­˜å·²ä¸‹è½½å’Œåˆæ­¥è®¾ç½®å¥½çš„ SDK ç›®å½•ã€‚
      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          # éœ€è¦ç¼“å­˜çš„ç›®å½•è·¯å¾„
          path: ${{ env.SDK_DIR }}
          # ç¼“å­˜é”®ï¼šç»“åˆæ“ä½œç³»ç»Ÿã€ç›®æ ‡æ¶æ„å’Œ OpenWrt ç‰ˆæœ¬ï¼Œç¡®ä¿ç¯å¢ƒå˜åŒ–æ—¶ç¼“å­˜å¤±æ•ˆ
          key: ${{ runner.os }}-sdk-${{ matrix.target.name }}-${{ env.OPENWRT_VERSION }}

      # æ­¥éª¤ 4: å‡†å¤‡ SDK (ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶è¿è¡Œ)
      # è¿™ä¸ªç»„åˆæ­¥éª¤åŒ…å«äº†ä¸‹è½½ã€è§£å‹ SDK å’Œæ›´æ–° feedsï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ SDK å‡†å¤‡è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¸€èµ·è¢«ç¼“å­˜ã€‚
      - name: Download, extract OpenWrt SDK and update feeds
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          # ä»ç¯å¢ƒå˜é‡ä¸­ç§»é™¤ 'v' å‰ç¼€ä»¥åŒ¹é…ç‰ˆæœ¬å·
          release_version="${OPENWRT_VERSION#v}"
          sdk_url_prefix="https://downloads.openwrt.org/releases/${release_version}/targets/${{ matrix.target.path }}"
          
          # æŸ¥æ‰¾ SDK æ–‡ä»¶å
          sdk_filename=$(curl -s "$sdk_url_prefix/" | \
                        grep -o '<a href="openwrt-sdk-.*-x86_64\.tar\.\(xz\|zst\)">' | \
                        sed -e 's/.*<a href="//' -e 's/">//' | \
                        head -n 1)

          if [ -z "$sdk_filename" ]; then
            echo "::error::Could not find SDK file at ${sdk_url_prefix}/"
            echo "Available files:"
            curl -s "$sdk_url_prefix/" | grep -o '<a href="[^"]*">[^<]*</a>' | sed -e 's/<a href="\(.*\)".*>\(.*\)/\1\t\2/'
            exit 1
          fi
          
          echo "Downloading SDK: ${sdk_url_prefix}/${sdk_filename}"
          wget -q "${sdk_url_prefix}/${sdk_filename}"
          
          echo "Extracting SDK..."
          # è§£å‹ SDK å¹¶é‡å‘½åä¸ºå›ºå®šçš„ç›®å½•åï¼Œä»¥åŒ¹é…ç¼“å­˜è·¯å¾„
          tar -xf "$sdk_filename"
          mv $(find . -maxdepth 1 -type d -name 'openwrt-sdk-*') ${{ env.SDK_DIR }}

          echo "Updating feeds..."
          cd ${{ env.SDK_DIR }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cd ..

      # æ­¥éª¤ 5: å‡†å¤‡æ„å»ºç¯å¢ƒ (åŒ…å«æ™ºèƒ½ç‰ˆæœ¬æ§åˆ¶)
      - name: Prepare build environment
        working-directory: ${{ env.SDK_DIR }}
        run: |
          rm -rf package/${PACKAGE_NAME}
          mkdir -p package/${PACKAGE_NAME}
          src_dir="${{ github.workspace }}"

          echo "Searching for Makefile in: $src_dir"
          # æŸ¥æ‰¾ Makefileï¼Œæœ€å¤§æ·±åº¦3ï¼ŒæŒ‰è·¯å¾„é•¿åº¦æ’åºï¼Œä¼˜å…ˆå–æœ€çŸ­è·¯å¾„çš„(é€šå¸¸æ˜¯æ ¹ç›®å½•çš„)
          # è¿‡æ»¤æ‰è·¯å¾„ä¸­åŒ…å« /bin/ æˆ– /obj/ çš„å¹²æ‰°é¡¹
          FOUND_MK=$(find "$src_dir" -maxdepth 3 -name Makefile -not -path "*/.*" | awk '{ print length, $0 }' | sort -n | cut -d" " -f2- | head -n 1)
          
          if [ -z "$FOUND_MK" ]; then
            echo "::error::Could not find any Makefile in the repository!"
            ls -R "$src_dir"
            exit 1
          fi
          
          echo "Found primary Makefile at: $FOUND_MK"
          pkg_src_dir=$(dirname "$FOUND_MK")
          echo "Determined package source root: $pkg_src_dir"

          rsync -a --delete "${pkg_src_dir}/" ./package/${PACKAGE_NAME}/
          
          # éªŒè¯å¤åˆ¶ç»“æœ
          TARGET_MK="./package/${PACKAGE_NAME}/Makefile"
          if [ ! -f "$TARGET_MK" ]; then
            echo "::error::Failed to migrate code. Makefile missing at $TARGET_MK"
            ls -R package/${PACKAGE_NAME}
            exit 1
          fi
          echo "Code migration successful. Structure verified."
          
          # æ£€æŸ¥ Makefile ä¸­æ˜¯å¦å·²å­˜åœ¨ PKG_VERSION å®šä¹‰
          if grep -q "^PKG_VERSION:=" "$TARGET_MK"; then
            echo "Static PKG_VERSION found in Makefile. Using upstream version definition."
            echo "::notice::You should not manually define PKG_VERSION or PKG_RELEASE in the Makefile. You should try using dynamic versioning."
          else
            echo "No static PKG_VERSION found. Applying dynamic versioning."
            
            NEW_VER=""
            NEW_REL=""

            if [ "${{ github.ref_type }}" = "tag" ]; then
              # === åœºæ™¯ A: Release Tag ===
              NEW_VER=$(echo "${{ github.ref_name }}" | sed 's/^v//')
              NEW_REL="1"
              echo "Build triggered by Tag: Using Version=$NEW_VER, Release=$NEW_REL"
            else
              # === åœºæ™¯ B: æ™®é€š Commit (è°ƒè¯•æ„å»º) ===
              # Version = æ—¥æœŸ (YYYY.MM.DD)
              NEW_VER=$(date +"%Y.%m.%d")
              
              # Release = BuildNumber.git-ShortHash
              SHORT_SHA=$(git -C "$src_dir" rev-parse --short HEAD)
              NEW_REL="${{ github.run_number }}.git-$SHORT_SHA"
              echo "Build triggered by Commit: Using Version=$NEW_VER, Release=$NEW_REL"
            fi

            # åŠ¨æ€æ³¨å…¥ç‰ˆæœ¬å·
            sed -i "s|include \$(TOPDIR)/rules.mk|include \$(TOPDIR)/rules.mk\nPKG_VERSION:=$NEW_VER\nPKG_RELEASE:=$NEW_REL|" "$TARGET_MK"
          fi

          translation_pkg=${PACKAGE_NAME#luci-app-}
          mkdir -p ./bin/packages
          find ./bin/packages -type f -name "${PACKAGE_NAME}*.ipk" -delete
          find ./bin/packages -type f -name "luci-i18n-${translation_pkg}-*.ipk" -delete
          {
            echo "CONFIG_PACKAGE_${PACKAGE_NAME}=m"
            echo "CONFIG_PACKAGE_luci-i18n-${translation_pkg}-zh-cn=m"
            echo "CONFIG_LUCI_LANG_zh_Hans=y"
          } > .config
          make defconfig

      # æ­¥éª¤ 6: ç¼–è¯‘è½¯ä»¶åŒ… (IPK)
      - name: Compile the package (IPK)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          make package/${PACKAGE_NAME}/compile V=s -j$(($(nproc) + 1))
          
          mkdir -p output_ipk
          translation_pkg=${PACKAGE_NAME#luci-app-}
          find ./bin/packages -type f \( -name "${PACKAGE_NAME}*.ipk" -o -name "luci-i18n-${translation_pkg}-*.ipk" \) -exec cp {} output_ipk/ \;

      # æ­¥éª¤ 7: ç¼–è¯‘è½¯ä»¶åŒ… (APK)
      - name: Compile the package (APK)
        working-directory: ${{ env.SDK_DIR }}
        run: |
          make package/${PACKAGE_NAME}/clean
          
          translation_pkg=${PACKAGE_NAME#luci-app-}
          {
            echo "CONFIG_PACKAGE_${PACKAGE_NAME}=m"
            echo "CONFIG_PACKAGE_luci-i18n-${translation_pkg}-zh-cn=m"
            echo "CONFIG_LUCI_LANG_zh_Hans=y"
            echo "CONFIG_USE_APK=y"
            echo "CONFIG_USE_OPKG=n"
          } > .config
          make defconfig
          
          if ! grep -q '^CONFIG_USE_APK=y' .config; then
            echo "::warning::CONFIG_USE_APK not available in this SDK. Skipping APK build."
            exit 0
          fi

          make package/${PACKAGE_NAME}/compile V=s -j$(($(nproc) + 1))
          
          mkdir -p output_apk
          find ./bin/packages -type f \( -name "${PACKAGE_NAME}*.apk" -o -name "luci-i18n-${translation_pkg}-*.apk" \) -exec cp {} output_apk/ \;

      # æ­¥éª¤ 8: æ”¶é›†å’Œå‡†å¤‡æ–‡ä»¶
      - name: Collect artifacts
        id: collect_artifacts
        working-directory: ${{ env.SDK_DIR }}
        run: |
          rm -rf upload
          mkdir -p upload
          
          if [ -d "output_ipk" ]; then
            echo "Copying IPK files..."
            cp output_ipk/*.ipk upload/ 2>/dev/null || true
          fi
          if [ -d "output_apk" ]; then
            echo "Copying APK files..."
            cp output_apk/*.apk upload/ 2>/dev/null || true
          fi
          
          if [ -z "$(ls -A upload)" ]; then
            echo "::error::No packages found!"
            ls -R ./bin/
            exit 1
          fi
          
          echo "Found packages:"
          ls -l upload/
          
          echo "path=upload" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 9: ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ matrix.target.name }}
          path: ${{ env.SDK_DIR }}/${{ steps.collect_artifacts.outputs.path }}
          if-no-files-found: error

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release-assets/**/*.ipk
            release-assets/**/*.apk
